{
  "timestamp": "20251017-164352",
  "stage": "S5 - Secret Manager Plan",
  "status": "SUCCESS",
  "environment_variable_scan": {
    "method": "PowerShell Select-String on apps/**/*.{ts,tsx,js,jsx}",
    "pattern": "process\\.env\\.([A-Z_]+)",
    "discovered_vars": [
      "ATLAS_API_KEY",
      "ATLAS_APP_NAME",
      "ATLAS_DRIVE_URL",
      "ATLAS_GATEWAY_URL",
      "ATLAS_WEBHOOK_SECRET",
      "JWKS_URL",
      "NODE_ENV",
      "NEXT_PUBLIC_APP_URL"
    ]
  },
  "secret_templates_created": [
    {
      "app": "proof-messenger",
      "file": "infra/gcp/secrets/proof-messenger.env.template.json",
      "secrets_count": 7,
      "required_secrets": [
        "NODE_ENV",
        "ATLAS_GATEWAY_URL",
        "ATLAS_DRIVE_URL"
      ],
      "optional_secrets": [
        "ATLAS_WEBHOOK_SECRET",
        "ATLAS_API_KEY",
        "JWKS_URL",
        "NEXT_PUBLIC_APP_URL"
      ]
    },
    {
      "app": "admin-insights",
      "file": "infra/gcp/secrets/admin-insights.env.template.json",
      "secrets_count": 4,
      "required_secrets": [
        "NODE_ENV",
        "ATLAS_GATEWAY_URL",
        "ATLAS_API_KEY"
      ],
      "optional_secrets": [
        "NEXT_PUBLIC_APP_URL"
      ]
    },
    {
      "app": "dev-portal",
      "file": "infra/gcp/secrets/dev-portal.env.template.json",
      "secrets_count": 3,
      "required_secrets": [
        "NODE_ENV",
        "ATLAS_GATEWAY_URL"
      ],
      "optional_secrets": [
        "NEXT_PUBLIC_APP_URL"
      ]
    }
  ],
  "secrets_sync_script": {
    "path": "infra/gcp/scripts/secrets-sync.sh",
    "purpose": "Sync environment variables from JSON templates to GCP Secret Manager",
    "features": [
      "Reads JSON templates and creates GCP secrets",
      "Idempotent (skips existing secrets)",
      "Validates jq dependency",
      "Skips placeholder values (requires manual replacement)",
      "Automatic replication policy"
    ],
    "usage": "Replace placeholders in templates, then run: bash infra/gcp/scripts/secrets-sync.sh"
  },
  "placeholder_replacements_required": {
    "proof-messenger": [
      "ATLAS_WEBHOOK_SECRET → Generate secure random string (32+ chars)",
      "ATLAS_API_KEY → Get from Atlas admin",
      "JWKS_URL → Set to JWKS endpoint if using JWT auth"
    ],
    "admin-insights": [
      "ATLAS_API_KEY → Get admin-scoped API key from Atlas"
    ],
    "dev-portal": []
  },
  "cloud_run_integration": {
    "method": "gcloud run deploy <service> --set-secrets=VAR_NAME=SECRET_NAME:latest",
    "example": "gcloud run deploy atlas-proof-messenger --set-secrets=ATLAS_API_KEY=atlas_proof_messenger_ATLAS_API_KEY:latest",
    "automatic_rotation": "Update secret versions in Secret Manager, Cloud Run picks up latest automatically"
  },
  "security_best_practices": [
    "Secrets stored in GCP Secret Manager (encrypted at rest)",
    "No secrets in code/env files (templates are documentation only)",
    "Quarterly secret rotation recommended",
    "Admin API keys have elevated permissions (restrict access)",
    "Webhook secrets should be 32+ character random strings"
  ],
  "next_stage": "S6 - Run bootstrap.sh, build/push images, deploy with canary traffic split"
}
