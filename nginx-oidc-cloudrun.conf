# ATLAS v14 NGINX Configuration for OIDC Cloud Run
# Micro-cache with SWR, lock, and normalized cache key

events {
    worker_connections 1024;
}

http {
    # Upstream for app service
    upstream atlas_app {
        server ${APP_UPSTREAM};
        keepalive 32;
    }
    
    # Micro-cache configuration
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=atlas_cache:10m max_size=1g inactive=60m use_temp_path=off;
    
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    server {
        listen 80;
        server_name _;
        
        # Micro-cache with SWR and lock (NGINX docs)
        proxy_cache atlas_cache;
        proxy_cache_valid 200 301 60s;
        proxy_cache_valid 404 1m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        proxy_cache_lock on;
        
        # Normalized cache key (path + normalized query + Accept-Encoding)
        proxy_cache_key "$scheme$request_method$host$request_uri$http_accept_encoding";
        
        # Ignore cookies on read, keep-alive on
        proxy_ignore_headers "Set-Cookie";
        proxy_set_header Connection "";
        proxy_http_version 1.1;
        
        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
        
        # Static assets - immutable cache
        location ~* ^/_next/static/ {
            proxy_pass https://atlas_app;
            proxy_cache_valid 200 301 1y;
            add_header Cache-Control "public, max-age=31536000, immutable";
            add_header X-Cache-Status $upstream_cache_status;
        }
        
        # Favicon mapping (if origin 404)
        location = /favicon.ico {
            proxy_pass https://atlas_app/favicon.svg;
            proxy_cache_valid 200 301 1y;
            add_header Cache-Control "public, max-age=31536000, immutable";
            add_header X-Cache-Status $upstream_cache_status;
        }
        
        # Cacheable GET routes (~90%)
        location ~ ^/(|keys|playground|metrics)$ {
            proxy_pass https://atlas_app;
            proxy_cache_valid 200 301 60s;
            add_header Cache-Control "public, max-age=60, stale-while-revalidate=30";
            add_header Vary "Accept-Encoding";
            add_header X-Cache-Status $upstream_cache_status;
        }
        
        # All other routes
        location / {
            proxy_pass https://atlas_app;
            add_header X-Cache-Status $upstream_cache_status;
        }
    }
}
