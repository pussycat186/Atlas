name: atlas-worker-autodeploy
on: { workflow_dispatch: {} }
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - name: Install Wrangler
        run: npm install -g wrangler@latest
      - name: Deploy Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          wrangler deploy --config wrangler.toml 2>&1 | tee deploy.log
          URL=$(grep -Eo 'https?://[a-z0-9-]+\.[a-z0-9-]+\.workers\.dev' deploy.log | head -1)
          echo "WORKER_URL=$URL" >> $GITHUB_ENV
          echo "Worker deployed to: $URL"
      - name: Fail if URL missing
        run: test -n "$WORKER_URL" || { echo "BLOCKER_WORKER_URL_NOT_FOUND"; exit 1; }
      - name: Print URL artifact
        run: echo "{\"worker_url\":\"$WORKER_URL\"}"