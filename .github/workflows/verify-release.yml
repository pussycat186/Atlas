name: verify-release
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Image tag to verify (default: latest)"
        required: false
        default: latest
permissions:
  contents: read
  packages: read
  id-token: write
jobs:
  verify:
    runs-on: ubuntu-latest
    env:
      OWNER: ${{ github.repository_owner }}
      TAG: ${{ inputs.tag || 'latest' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Install crane
        uses: imjasonh/setup-crane@v0.4

      - name: Resolve digests
        id: dig
        run: |
          set -euo pipefail
          echo "gw=$(crane digest ghcr.io/${OWNER}/atlas-gateway:${TAG})" >> $GITHUB_OUTPUT
          echo "wt=$(crane digest ghcr.io/${OWNER}/atlas-witness:${TAG})" >> $GITHUB_OUTPUT
          echo "Gateway: ${{ 'ghcr.io/' }}${OWNER}/atlas-gateway:${TAG} -> ${{ steps.dig.outputs.gw }}"
          echo "Witness: ${{ 'ghcr.io/' }}${OWNER}/atlas-witness:${TAG} -> ${{ steps.dig.outputs.wt }}"

      - name: Cosign verify (gateway)
        env: { COSIGN_EXPERIMENTAL: 1 }
        run: |
          cosign verify \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            --certificate-identity-regexp="https://github.com/${{ github.repository_owner }}/$(basename $GITHUB_REPOSITORY)/\\.github/workflows/release\\.yml@refs/tags/.*" \
            ghcr.io/${{ github.repository_owner }}/atlas-gateway@${{ steps.dig.outputs.gw }}

      - name: Cosign verify (witness)
        env: { COSIGN_EXPERIMENTAL: 1 }
        run: |
          cosign verify \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            --certificate-identity-regexp="https://github.com/${{ github.repository_owner }}/$(basename $GITHUB_REPOSITORY)/\\.github/workflows/release\\.yml@refs/tags/.*" \
            ghcr.io/${{ github.repository_owner }}/atlas-witness@${{ steps.dig.outputs.wt }}

      - name: Note: SLSA verification skipped
        run: |
          echo "SLSA verification would be performed here"
          echo "Images are published with provenance: true in release workflow"
          echo "Gateway digest: ${{ steps.dig.outputs.gw }}"
          echo "Witness digest: ${{ steps.dig.outputs.wt }}"